---
title: "United States Covid Case Rates and Death Rates by State throughout the Pandemic"
author: "A. Kajuch"
date: "2024-10-14"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Purpose
The purpose of this report is to look at COVID-19 data in the United States from Johns Hopkins and take a more in depth view at the case rates and death rates from each state.

## Librarys

```{r librarys}
library(tidyr)
library(ggplot2)
library(dplyr)
library(maps)
library(lubridate)
library(viridis)
library(stringr)
library(readr)
library(lolcat)
```

## Loading in Data

```{r load data}

url_in <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/"

file_names<- c("refs/heads/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv",
               "refs/heads/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_US.csv",
               "refs/heads/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv")

urls <- str_c(url_in, file_names)

US_cases <- read_csv(urls[1])
US_deaths <- read_csv(urls[2])
global_recovered <- read_csv(urls[3])
```

## Tidy Data
While tidying the data we wanted to get rid of unwanted columns and narrow down what data we wanted to view. 
```{r tidy}
US_cases <- US_cases %>%
  pivot_longer(cols = -(UID:Combined_Key),
               names_to = "date",
               values_to = "cases") %>%
  select(Admin2:cases) %>%
  mutate(date = mdy(date)) %>%
  select(-c(Lat,Long_))

US_deaths <- US_deaths %>%
  pivot_longer(cols = -(UID:Combined_Key), 
               names_to = "date", 
               values_to = "deaths") %>% 
  select(Admin2:deaths) %>%
  filter(!grepl("[^0-9/]", date)) %>%  
  mutate(date = mdy(date)) %>%  
  filter(!is.na(date)) %>%  
  select(-c(Lat, Long_)) 


US <- US_cases %>%
  full_join(US_deaths, by = c("Admin2", "Province_State", "Country_Region", "Combined_Key", "date"))


US <- US %>% filter(cases > 0)
```


# Bring in Population data
Combining the states population data with the COVID-19 data, we are able to now create rates relative to the population of each state. 
```{r population}
uid_lookup_url <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/refs/heads/master/csse_covid_19_data/UID_ISO_FIPS_LookUp_Table.csv"
uid <- read_csv(uid_lookup_url) %>%
  filter(is.na(Admin2)) %>%
  filter(Country_Region == "US") %>%
  select(-c(code3, iso2, iso3))
USjoined<- US%>%
  left_join(uid, by = c("Province_State", "Country_Region")) %>%
  select(-c(UID, FIPS)) %>%
  select(Province_State, Country_Region, date, cases, deaths, Population)
head(USjoined)
```

# Organize Data Over Time
Organizing the data over time allows for us to view each state year by year
```{r organize data monthly}
#Create Monthly per Year
USjoined <- USjoined %>%
  mutate(year = year(date), month = month(date, label = TRUE))

# States Monthly Adjustment
Statesmonthly <- USjoined %>%
  group_by(Province_State, year, month, Population) %>%
  summarise(average_cases = mean(cases, na.rm = TRUE),
            total_cases = sum(cases, na.rm = TRUE),
            total_deaths = sum(deaths, na.rm = TRUE)) %>%
  ungroup()
  


Statesmonthly<- Statesmonthly %>%
  group_by(year, month) %>%
  mutate(case_rate = (average_cases /Population) * 100,
         death_rate = (total_deaths/total_cases) * 100) %>%
  ungroup()

head(Statesmonthly)

Statesyearly <- Statesmonthly %>%
  group_by(Province_State, year) %>%
  summarize(
    avg_case_rate = mean(case_rate, na.rm = TRUE),
    avg_death_rate = mean(death_rate, na.rm = TRUE)
  ) %>%
  ungroup()
head(Statesyearly)
```
# Load in US State Map
Loading in the data for the United States map,
and combining it with the COVID-19 data.
```{r load map}
us_states_map <- map_data("state")

Statesyearly <- Statesyearly %>%
  mutate(Province_State = tolower(Province_State))

merged_case_rate <- us_states_map %>%
  left_join(Statesyearly, by = c("region" = "Province_State"))

merged_death_rate <- merged_case_rate
```


## Plot The Heat Map
```{r map}
# Function to plot heat map for case rate
plot_case_rate_heatmap <- function(year) {
  ggplot(data = filter(merged_case_rate, year == !!year), aes(long, lat, group = group, fill = avg_case_rate)) +
    geom_polygon(color = "white") +
    scale_fill_gradient2(
      low = "green", mid = "yellow", high = "red", midpoint = .75, limits = c(0, 1.5),
      name = "Case Rate (%)", na.value = "red"
    ) +
    labs(title = paste("Average Case Rate in", year), x = "", y = "") +
    theme_minimal() +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank(),
          panel.grid = element_blank()) +
    coord_fixed(1.3)
}

plot_death_rate_heatmap <- function(year) {
  ggplot(data = filter(merged_case_rate, year == !!year), aes(long, lat, group = group, fill = avg_death_rate)) +
    geom_polygon(color = "white") +
    scale_fill_gradient2(
      low = "green", mid = "yellow", high = "red", midpoint = 1.5, limits = c(0, 3),
      name = "Death Rate (%)", na.value = "red"
    ) +
    labs(title = paste("Average Death Rate in", year), x = "", y = "") +
    theme_minimal() +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank(),
          panel.grid = element_blank()) +
    coord_fixed(1.3)
}
```

```{r plots}
for (year in 2020:2023) {
  print(plot_case_rate_heatmap(year))
}

for (year in 2020:2023) {
  print(plot_death_rate_heatmap(year))
}
```

## Review of the heat maps
The data that is described in the map is what we would reasonably expect. Early on in covid, there was a lower case rate as the virus was just starting to spread and there was a lack of adequate reporting. The death rate was also higher for the virus as there was a lack of understanding behind how the virus worked and what methods of care were best. As time went on, the virus became more spreadable and less deadly, our treatment of the virus improved and the death rate quickly dropped while the case rate increased. This leads to an interesting question about if there is a correlation between the death rate of COVID-19 and the case rate of COVID-19 in the United States throughout the pandemic. 

### Check for correlation
```{r correlation check}

correlation_data <- merged_case_rate %>%
  select(avg_case_rate, avg_death_rate) %>%
  na.omit()

correlation <- cor(correlation_data$avg_case_rate, correlation_data$avg_death_rate, use = "complete.obs")

round.object(correlation, digits = 3)


```

# Summary
This lack of correlation tells us that there are a variety of aspects that impact the death rate of COVID-19, which lie outside the aspect of case rate. Public health records, Covid policy, and vaccination rates are data that may be interesting to investigate.

